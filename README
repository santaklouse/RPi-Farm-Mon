# Raspberry Pi Initial Setup (For Raspbian Jessie Lite)

# For only Pi 3
echo "dtoverlay=pi3-miniuart-bt" > /boot/config.txt
echo "dwc_otg.lpm_enable=0 console=tty1 console=serial0,115200 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait" > /boot/cmdline.txt

# new hostname is "broccoli"
sudo sh -c 'echo "broccoli" > /etc/hostname'
sudo sh -c 'echo "127.0.0.1       localhost" > /etc/hosts'
sudo sh -c 'echo "127.0.1.1       broccoli" >> /etc/hosts'

# Enable Wireless LAN
sudo sh -c 'cat <<EOF > /etc/network/interfaces 
source-directory /etc/network/interfaces.d
auto lo
iface lo inet loopback
allow-hotplug wlan0
iface wlan0 inet manual
wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf
EOF'

sudo sh -c 'cat <<EOF > /etc/wpa_supplicant/wpa_supplicant.conf
country=JP
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
network={
    ssid="SSID"                 # < Change as you need
    psk="PASSWORD"              # < Change as you need
}
EOF'

sudo ifup wlan0

# Disabling IPv6
# https://www.raspberrypi.org/forums/viewtopic.php?t=138899

sudo sh -c 'cat <<EOF > /etc/modprobe.d/ipv6.conf
alias net-pf-10 off
alias ipv6 off
options ipv6 disable_ipv6=1
blacklist ipv6
EOF'

sudo sh -c 'cat <<EOF >> /etc/sysctl.conf
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
net.ipv6.conf.eth0.disable_ipv6 = 1
net.ipv6.conf.[interface].disable_ipv6 = 1
EOF'

# Remove unnecessary packages
sudo apt-get autoremove --purge -y alsa-utils bluez cifs-utils dosfstools dphys-swapfile ed fbset kbd keyboard-configuration libfreetype6:armhf libgpm2:armhf liblockfile1:armhf libpng12-0:armhf nano nfs-common ntp rsyslog vim-tiny
v4l-utils xauth xdg-user-dirs xkb-data
# Update packages
sudo sh -c "echo 'deb http://ftp.jaist.ac.jp/raspbian/ jessie main contrib non-free rpi' > /etc/apt/sources.list"
sudo apt-get update
sudo apt-get -y upgrade

# Update Firmware
sudo rpi-update

# Configure gpu memory assignment
sudo sh -c "echo 'gpu_mem=16' >> /boot/config.txt"

# Install additional packages
sudo apt-get install -y vim
cat <<EOF > ~/.vimrc
syntax enable
set nobackup
set noswapfile
set visualbell
set expandtab
set tabstop=4
set shiftwidth=4
EOF

# Time Setting
sudo ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
sudo apt-get install -y ntpdate
sudo ntpdate ntp.nict.jp
sudo crontab -e

    :
    :
    55 * * * * ntpdate ntp.nict.jp >/dev/null 2>&1

# Enable required daemon
sudo systemctl enable ssh
sudo systemctl enable avahi-daemon

sudo reboot
