# Raspberry Pi Initial Setup (For Raspbian Jessie Lite)

# For only Pi 3
echo "dtoverlay=pi3-miniuart-bt" >> /Volumes/boot/config.txt

sudo bash

# new hostname is "broccoli"
echo "broccoli" > /etc/hostname
echo "127.0.0.1       localhost" > /etc/hosts
echo "127.0.1.1       broccoli" >> /etc/hosts

# Enable Wireless LAN

cat <<EOF > /etc/network/interfaces 
source-directory /etc/network/interfaces.d
auto lo
iface lo inet loopback
allow-hotplug wlan0
iface wlan0 inet static
address 192.168.100.1
netmask 255.255.255.0
allow-hotplug wlan1
iface wlan1 inet manual
    wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf
EOF

cat <<EOF > /etc/wpa_supplicant/wpa_supplicant.conf
country=JP
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
network={
    ssid="SSID"                 # < Change as you need
    psk="PASSWORD"              # < Change as you need
}
EOF

# Disabling IPv6
# https://www.raspberrypi.org/forums/viewtopic.php?t=138899

cat <<EOF > /etc/modprobe.d/ipv6.conf
alias net-pf-10 off
alias ipv6 off
options ipv6 disable_ipv6=1
blacklist ipv6
EOF

cat <<EOF >> /etc/sysctl.conf
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
net.ipv6.conf.eth0.disable_ipv6 = 1
net.ipv6.conf.[interface].disable_ipv6 = 1
EOF

ifdown wlan1
ifup wlan1

echo 'deb http://ftp.jaist.ac.jp/raspbian/ jessie main contrib non-free rpi' > /etc/apt/sources.list

apt-get update
apt-get autoremove --purge -y alsa-utils bluez cifs-utils dosfstools dphys-swapfile ed fbset kbd keyboard-configuration libfreetype6:armhf libpng12-0:armhf nano nfs-common ntp rsyslog vim-tiny v4l-utils xauth xdg-user-dirs xkb-data
apt-get autoremove --purge -y
apt-get -y upgrade

# Install additional packages
sudo apt-get install -y vim ntpdate git

# Time Setting
ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
ntpdate ntp.nict.jp
crontab -e

    55 * * * * ntpdate ntp.nict.jp >/dev/null 2>&1

# Enable required daemon
systemctl enable ssh
systemctl enable avahi-daemon

# Update Firmware
rpi-update

reboot

# Wireless Router Setting
# https://www.raspberrypi.org/documentation/configuration/wireless/access-point.md
# https://wiki.debian.org/BuildingTutorial#The_packaging_workflow
# https://github.com/pritambaral/hostapd-rtl871xdrv

sudo bash

echo "denyinterfaces wlan0" >> /etc/dhcpcd.conf

apt-get install -y dnsmasq hostapd
systemctl stop dnsmasq
systemctl stop hostapd

# DHCP Server
echo "interface=wlan0" > /etc/dnsmasq.conf
echo "dhcp-range=192.168.100.20,192.168.100.50,255.255.255.0" >> /etc/dnsmasq.conf

# hostapd
wget http://www.adafruit.com/downloads/adafruit_hostapd.zip
unzip adafruit_hostapd.zip
mv hostapd /opt/bin
chmod 755 /opt/bin/hostapd
ln -sf /opt/bin/hostapd /usr/sbin/hostapd
rm adafruit_hostapd.zip

cat <<EOF > /etc/hostapd/hostapd.conf
interface=wlan0
driver=rtl871xdrv
ssid=raspberry
hw_mode=g
channel=6
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=raspberry
wpa_key_mgmt=WPA-PSK
wpa_pairwise=CCMP
wpa_group_rekey=86400
ieee80211n=1
wme_enabled=1
EOF
echo DAEMON_CONF="/etc/hostapd/hostapd.conf" > /etc/default/hostapd

hostapd /etc/hostapd/hostapd.conf

systemctl enable dnsmasq.service
systemctl start dnsmasq.service
systemctl enable hostapd.service
systemctl start hostapd.service

# Routing
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -t nat -A POSTROUTING -o wlan1 -j MASQUERADE
iptables -A FORWARD -i wlan1 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i wlan0 -o wlan1 -j ACCEPT
iptables-save > /etc/iptables.ipv4.nat
echo 'iptables-restore < /etc/iptables.ipv4.nat' > /lib/dhcpcd/dhcpcd-hooks/70-ipv4-nat

reboot

# Homebridge

wget https://nodejs.org/dist/v6.11.4/node-v6.11.4-linux-armv7l.tar.xz
tar xvJf node-v6.11.4-linux-armv7l.tar.xz
sudo mv node-v6.11.4-linux-armv7l /opt/node
rm node-v6.11.4-linux-armv7l.tar.xz
sudo update-alternatives --install "/usr/bin/node" "node" "/opt/node/bin/node" 1
sudo update-alternatives --install "/usr/bin/npm" "npm" "/opt/node/bin/npm" 1


sudo apt-get install -y libavahi-compat-libdnssd-dev
sudo /opt/node/bin/npm install -g homebridge
sudo /opt/node/bin/npm install -g homebridge-cmd

git clone https://github.com/mbuzz15/RPi-Farm-Mon
mkdir .homebridge
cp rpi-farm-mon/sample/config.json.sample .homebridge/config.json

/opt/node/lib/node_modules/homebridge/bin/homebridge

sudo touch /etc/default/homebridge
sudo cp /home/pi/rpi-farm-mon/sample/homebridge.service.sample /etc/systemd/system/homebridge.service
sudo systemctl daemon-reload
sudo systemctl start homebridge
sudo systemctl enable homebridge
sudo systemctl status homebridge



